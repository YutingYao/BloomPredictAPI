# è“è—»é¢„æµ‹ç³»ç»ŸAPI V2å‡çº§æŒ‡å—

## ğŸš€ å‡çº§æ¦‚è¿°

API V2ç‰ˆæœ¬å®Œå…¨è§£å†³äº†æ‚¨æåˆ°çš„è¾“å…¥æ•°æ®é—®é¢˜ï¼š**"APIæ¥å£çš„inputä¸å¯¹ï¼Œä½ åº”è¯¥input60å¤©çš„å†å²æ•°æ®ï¼Œä½†æ˜¯60å¤©çš„æ•°æ®å…¨éƒ¨æ”¾å…¥inputæ˜¯ä¸æ˜¯ä¸å¥½çœ‹ï¼Ÿ"**

### é—®é¢˜åˆ†æ

**V1ç‰ˆæœ¬å­˜åœ¨çš„é—®é¢˜ï¼š**
- âŒ æ¨¡å‹éœ€è¦60å¤©Ã—12ç‰¹å¾=720ä¸ªæ•°å€¼ï¼Œä½†APIåªæ¥å—1å¤©çš„æ•°æ®
- âŒ å¦‚æœç›´æ¥ä¼ å…¥720ä¸ªæ•°å€¼ï¼ŒJSONä¼šå˜å¾—æå…¶è‡ƒè‚¿
- âŒ ç”¨æˆ·å¾ˆéš¾æ‰‹å·¥æ„é€ 60å¤©çš„å†å²æ•°æ®
- âŒ ä¸ç¬¦åˆç¯å¢ƒç›‘æµ‹ç³»ç»Ÿçš„å®é™…ä¸šåŠ¡éœ€æ±‚

**V2ç‰ˆæœ¬çš„è§£å†³æ–¹æ¡ˆï¼š**
- âœ… æ™ºèƒ½å†å²æ•°æ®è·å–ï¼šåªéœ€æŒ‡å®šç«™ç‚¹å’Œæ—¥æœŸï¼Œç³»ç»Ÿè‡ªåŠ¨è·å–60å¤©æ•°æ®
- âœ… APIç®€æ´ç¾è§‚ï¼šä»720ä¸ªæ•°å€¼ç®€åŒ–ä¸º5ä¸ªæ ¸å¿ƒå‚æ•°
- âœ… ä¸šåŠ¡é€»è¾‘åˆç†ï¼šç¬¦åˆç¯å¢ƒç›‘æµ‹ç³»ç»Ÿçš„å®é™…ä½¿ç”¨åœºæ™¯
- âœ… åŠŸèƒ½æ›´å¼ºå¤§ï¼šæ”¯æŒæ•°æ®è´¨é‡éªŒè¯ã€å®æ—¶æ•°æ®è¡¥å……ç­‰

## ğŸ“Š APIå¯¹æ¯”

### V1ç‰ˆæœ¬ (æœ‰é—®é¢˜çš„è®¾è®¡)

```json
{
  "station": "èƒ¥æ¹–å¿ƒ",
  "model_type": "grud",
  "predict_days": 7,
  "input_data": {
    // åªæœ‰1å¤©çš„æ•°æ®ï¼Œä½†æ¨¡å‹å®é™…éœ€è¦60å¤©ï¼
    "temperature": 25.5,
    "oxygen": 8.2,
    "TN": 1.5,
    "TP": 0.08,
    "NH": 0.5,
    "pH": 7.8,
    "turbidity": 15.2,
    "conductivity": 420.0,
    "permanganate": 3.5,
    "rain_sum": 0.0,
    "wind_speed_10m_max": 3.2,
    "shortwave_radiation_sum": 18.5
  }
}
```

**é—®é¢˜ï¼š**æ•°æ®ç»´åº¦ä¸åŒ¹é…ï¼æ¨¡å‹éœ€è¦ `(60, 12)` çš„è¾“å…¥ï¼Œä½†åªæä¾›äº† `(1, 12)` çš„æ•°æ®ã€‚

### V2ç‰ˆæœ¬ (ä¼˜åŒ–åçš„è®¾è®¡)

```json
{
  "station": "èƒ¥æ¹–å¿ƒ",
  "model_type": "grud",
  "predict_days": 7,
  "data_mode": "auto_historical",
  "end_date": "2024-05-31",
  "seq_length": 60
}
```

**ä¼˜åŠ¿ï¼š**ç³»ç»Ÿè‡ªåŠ¨ä»CSVæ•°æ®æ–‡ä»¶ä¸­è·å–2024-04-02åˆ°2024-05-31çš„60å¤©å†å²æ•°æ®ï¼Œå®Œç¾åŒ¹é…æ¨¡å‹éœ€æ±‚ï¼

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. æ™ºèƒ½å†å²æ•°æ®è·å– (æ¨è)

**åŠŸèƒ½ï¼š**ç³»ç»Ÿè‡ªåŠ¨ä»dataç›®å½•çš„CSVæ–‡ä»¶ä¸­è·å–æŒ‡å®šæ—¶é—´èŒƒå›´çš„å†å²æ•°æ®ã€‚

```json
{
  "station": "èƒ¥æ¹–å¿ƒ",
  "model_type": "grud", 
  "predict_days": 7,
  "data_mode": "auto_historical",
  "end_date": "2024-05-31",
  "seq_length": 60,
  "fill_missing_method": "interpolation",
  "validate_data_quality": true
}
```

**å¤„ç†æµç¨‹ï¼š**
1. ğŸ“‚ ä» `data/002-æ°”è±¡-èƒ¥æ¹–å¿ƒ-merged_with_weather_with_composite_features_processed.csv` åŠ è½½æ•°æ®
2. ğŸ“… è‡ªåŠ¨è®¡ç®—æ—¶é—´èŒƒå›´ï¼š2024-04-02 åˆ° 2024-05-31 (60å¤©)
3. ğŸ” æå–12ä¸ªæ ¸å¿ƒç‰¹å¾ï¼š`temperature`, `pH`, `oxygen`, `permanganate`, `TN`, `conductivity`, `turbidity`, `rain_sum`, `wind_speed_10m_max`, `shortwave_radiation_sum`, `TP`, `NH`
4. ğŸ› ï¸ å¤„ç†ç¼ºå¤±å€¼ï¼šä½¿ç”¨æ’å€¼ã€å‰å‘å¡«å……ç­‰æ–¹æ³•
5. âœ… æ„é€ æ¨¡å‹æ‰€éœ€çš„ `(60, 12)` è¾“å…¥æ•°ç»„

### 2. æ··åˆæ¨¡å¼ (å†å²æ•°æ®+å®æ—¶è¡¥å……)

**åŠŸèƒ½ï¼š**åŸºäºå†å²æ•°æ®ï¼Œå…è®¸ç”¨æˆ·è¦†ç›–æœ€è¿‘å‡ å¤©çš„å®é™…ç›‘æµ‹å€¼ã€‚

```json
{
  "station": "èƒ¥æ¹–å¿ƒ",
  "model_type": "grud",
  "predict_days": 5, 
  "data_mode": "hybrid",
  "end_date": "2024-05-31",
  "seq_length": 60,
  "override_recent_days": 3,
  "supplementary_data": [
    {
      "date": "2024-05-29",
      "temperature": 26.5,
      "oxygen": 8.2,
      "pH": 7.8
    },
    {
      "date": "2024-05-30", 
      "temperature": 27.1,
      "oxygen": 7.9,
      "pH": 7.9
    },
    {
      "date": "2024-05-31",
      "temperature": 28.0,
      "oxygen": 7.5,
      "pH": 8.0
    }
  ]
}
```

### 3. æ•°æ®è´¨é‡éªŒè¯

**åŠŸèƒ½ï¼š**è‡ªåŠ¨æ£€æµ‹å’ŒæŠ¥å‘Šæ•°æ®è´¨é‡é—®é¢˜ã€‚

```json
{
  "quality_report": {
    "score": 0.876,
    "warnings": [
      "temperature å­˜åœ¨å¼‚å¸¸å€¼èŒƒå›´",
      "TP ç¼ºå¤±ç‡è¾ƒé«˜: 12.3%"
    ],
    "missing_ratio": 0.034
  }
}
```

### 4. æ‰¹é‡é¢„æµ‹

**åŠŸèƒ½ï¼š**æ”¯æŒå¤šä¸ªç«™ç‚¹/æ¨¡å‹çš„å¹¶è¡Œé¢„æµ‹ã€‚

```json
{
  "requests": [
    {
      "station": "èƒ¥æ¹–å¿ƒ",
      "model_type": "grud",
      "predict_days": 7,
      "data_mode": "auto_historical", 
      "end_date": "2024-05-31"
    },
    {
      "station": "é”¡ä¸œæ°´å‚",
      "model_type": "grud", 
      "predict_days": 7,
      "data_mode": "auto_historical",
      "end_date": "2024-05-31"
    }
  ],
  "parallel_execution": true
}
```

## ğŸ—‚ï¸ æ•°æ®æ¶æ„

### CSVæ•°æ®æ–‡ä»¶ç»“æ„

V2ç‰ˆæœ¬ç›´æ¥åˆ©ç”¨é¡¹ç›®ä¸­å·²æœ‰çš„6ä¸ªCSVæ–‡ä»¶ï¼š

```
data/
â”œâ”€â”€ 002-æ°”è±¡-èƒ¥æ¹–å¿ƒ-merged_with_weather_with_composite_features_processed.csv
â”œâ”€â”€ 002-æ°”è±¡-é”¡ä¸œæ°´å‚-merged_with_weather_with_composite_features_processed.csv  
â”œâ”€â”€ 002-æ°”è±¡-å¹³å°å±±-merged_with_weather_with_composite_features_processed.csv
â”œâ”€â”€ 002-æ°”è±¡-tuoshan-merged_with_weather_with_composite_features_processed.csv
â”œâ”€â”€ 002-æ°”è±¡-lanshanzui-merged_with_weather_with_composite_features_processed.csv
â””â”€â”€ 002-æ°”è±¡-äº”é‡Œæ¹–å¿ƒ-merged_with_weather_with_composite_features_processed.csv
```

### æ•°æ®å­—æ®µæ˜ å°„

```python
# æ ¸å¿ƒç‰¹å¾å­—æ®µ (æ¨¡å‹è¾“å…¥)
base_features = [
    'temperature',           # æ¸©åº¦
    'pH',                   # pHå€¼
    'oxygen',               # æº¶è§£æ°§
    'permanganate',         # é«˜é”°é…¸ç›æŒ‡æ•°
    'TN',                   # æ€»æ°®
    'conductivity',         # ç”µå¯¼ç‡
    'turbidity',            # æµŠåº¦
    'rain_sum',             # é™é›¨é‡
    'wind_speed_10m_max',   # é£é€Ÿ
    'shortwave_radiation_sum', # çŸ­æ³¢è¾å°„
    'TP',                   # æ€»ç£·
    'NH'                    # æ°¨æ°®
]

# æ—¶é—´å­—æ®µ
date_field = 'date'  # æ ¼å¼: YYYY-MM-DD
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨V2æœåŠ¡

```bash
cd /home/devbox/project/--API
python main_v2.py
```

æœåŠ¡å°†åœ¨ `http://localhost:8001` å¯åŠ¨

### 2. åŸºç¡€é¢„æµ‹è°ƒç”¨

```python
import requests

response = requests.post('http://localhost:8001/api/v2/predict', json={
    "station": "èƒ¥æ¹–å¿ƒ",
    "model_type": "grud",
    "predict_days": 7,
    "data_mode": "auto_historical", 
    "end_date": "2024-05-31"
})

result = response.json()
print(f"é¢„æµ‹ç»“æœ: {result['data']['prediction']}")
```

### 3. è¿è¡Œæ¼”ç¤ºè„šæœ¬

```bash
python demo_api_v2.py
```

æ¼”ç¤ºè„šæœ¬å°†å±•ç¤ºæ‰€æœ‰V2åŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•ã€‚

## ğŸ“š APIæ¥å£æ–‡æ¡£

### ä¸»è¦ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/api/v2/predict` | POST | æ ¸å¿ƒé¢„æµ‹æ¥å£V2 |
| `/api/v2/batch-predict` | POST | æ‰¹é‡é¢„æµ‹ |
| `/api/v2/validate-request` | POST | è¯·æ±‚éªŒè¯ |
| `/api/v2/data-info/{station}` | GET | ç«™ç‚¹æ•°æ®æ‘˜è¦ |
| `/api/v2/historical-data` | POST | è·å–å†å²æ•°æ® |
| `/api/v2/input-schema` | GET | è¾“å…¥æ ¼å¼è¯´æ˜ |

### å®Œæ•´APIæ–‡æ¡£

è®¿é—® `http://localhost:8001/docs` æŸ¥çœ‹Swaggerè‡ªåŠ¨ç”Ÿæˆçš„äº¤äº’å¼æ–‡æ¡£ã€‚

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®ç¼“å­˜

- å†å²æ•°æ®è‡ªåŠ¨ç¼“å­˜ï¼Œé¿å…é‡å¤è¯»å–CSVæ–‡ä»¶
- æ¨¡å‹ç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½

### 2. å¹¶è¡Œå¤„ç†

- æ‰¹é‡é¢„æµ‹æ”¯æŒå¹¶è¡Œæ‰§è¡Œ
- å¼‚æ­¥I/Oä¼˜åŒ–æ•°æ®è¯»å–

### 3. æ™ºèƒ½é¢„å¤„ç†

- åªåœ¨éœ€è¦æ—¶è¿›è¡Œæ•°æ®é¢„å¤„ç†
- ç¼ºå¤±å€¼å¤„ç†ç®—æ³•ä¼˜åŒ–

## ğŸ”’ æ•°æ®éªŒè¯

### è¾“å…¥éªŒè¯

- ç«™ç‚¹åç§°éªŒè¯
- æ—¥æœŸæ ¼å¼å’ŒèŒƒå›´éªŒè¯  
- æ¨¡å‹ç±»å‹éªŒè¯
- å‚æ•°èŒƒå›´éªŒè¯

### æ•°æ®è´¨é‡éªŒè¯

- ç¼ºå¤±å€¼æ£€æµ‹
- å¼‚å¸¸å€¼è¯†åˆ«
- æ•°æ®è¦†ç›–ç‡è®¡ç®—
- è´¨é‡è¯„åˆ†ç”Ÿæˆ

## ğŸš¨ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

| é”™è¯¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| `æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨` | CSVæ–‡ä»¶è·¯å¾„é”™è¯¯ | æ£€æŸ¥dataç›®å½•ä¸­çš„æ–‡ä»¶ |
| `æ—¥æœŸè¶…å‡ºèŒƒå›´` | è¯·æ±‚æ—¥æœŸä¸åœ¨æ•°æ®èŒƒå›´å†… | ä½¿ç”¨ `/api/v2/data-info/{station}` æŸ¥è¯¢å¯ç”¨æ—¥æœŸèŒƒå›´ |
| `æ¨¡å‹åŠ è½½å¤±è´¥` | æ¨¡å‹æ–‡ä»¶æŸåæˆ–ç¼ºå¤± | æ£€æŸ¥modelsç›®å½•ä¸­çš„æ¨¡å‹æ–‡ä»¶ |
| `æ•°æ®è´¨é‡è¿‡ä½` | ç¼ºå¤±å€¼è¿‡å¤šæˆ–å¼‚å¸¸å€¼è¿‡å¤š | è°ƒæ•´ `fill_missing_method` æˆ–ä½¿ç”¨ä¸åŒæ—¶é—´èŒƒå›´ |

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»V1è¿ç§»åˆ°V2

1. **æ›´æ–°è¯·æ±‚æ ¼å¼**
   ```python
   # V1 (æœ‰é—®é¢˜)
   old_request = {
       "station": "èƒ¥æ¹–å¿ƒ",
       "model_type": "grud", 
       "predict_days": 7,
       "input_data": { /* åªæœ‰1å¤©æ•°æ® */ }
   }
   
   # V2 (æ­£ç¡®)
   new_request = {
       "station": "èƒ¥æ¹–å¿ƒ",
       "model_type": "grud",
       "predict_days": 7,
       "data_mode": "auto_historical",
       "end_date": "2024-05-31"
   }
   ```

2. **æ›´æ–°APIç«¯ç‚¹**
   - V1: `POST /api/predict`
   - V2: `POST /api/v2/predict`

3. **å¤„ç†å“åº”æ ¼å¼å˜åŒ–**
   ```python
   # V2å“åº”åŒ…å«æ›´å¤šä¿¡æ¯
   response = {
       "data": {
           "prediction": [...],
           "prediction_dates": [...],
           "input_stats": {...},
           "quality_report": {...},  # æ–°å¢
           "data_info": {...}        # æ–°å¢
       }
   }
   ```

## ğŸ“ˆ ä¸šåŠ¡ä»·å€¼

### è§£å†³çš„æ ¸å¿ƒé—®é¢˜

1. **æ•°æ®è¾“å…¥é—®é¢˜**ï¼šä»éœ€è¦æ„é€ 720ä¸ªæ•°å€¼ç®€åŒ–ä¸º5ä¸ªå‚æ•°
2. **ä¸šåŠ¡é€»è¾‘å¯¹é½**ï¼šç¬¦åˆç¯å¢ƒç›‘æµ‹ç³»ç»Ÿçš„å®é™…å·¥ä½œæµç¨‹
3. **ç”¨æˆ·ä½“éªŒæå‡**ï¼šAPIè°ƒç”¨æ›´ç®€å•ã€ç›´è§‚
4. **åŠŸèƒ½å¢å¼º**ï¼šå¢åŠ æ•°æ®éªŒè¯ã€æ‰¹é‡å¤„ç†ç­‰é«˜çº§åŠŸèƒ½

### é€‚ç”¨åœºæ™¯

1. **å®æ—¶ç›‘æµ‹é¢„è­¦**ï¼šåŸºäºæœ€æ–°æ•°æ®è¿›è¡ŒçŸ­æœŸé¢„æµ‹
2. **å†å²åˆ†æå›æµ‹**ï¼šä½¿ç”¨å†å²æ—¶é—´ç‚¹æ•°æ®è¿›è¡Œæ¨¡å‹éªŒè¯
3. **æ‰¹é‡ç«™ç‚¹åˆ†æ**ï¼šåŒæ—¶å¯¹å¤šä¸ªç«™ç‚¹è¿›è¡Œé¢„æµ‹å¯¹æ¯”
4. **æ•°æ®è´¨é‡ç›‘æ§**ï¼šè¯„ä¼°ç›‘æµ‹æ•°æ®çš„å®Œæ•´æ€§å’Œå¯é æ€§

## ğŸ› ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           FastAPI Application          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PredictionServiceV2 (é¢„æµ‹æœåŠ¡V2)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  HistoricalDataService (å†å²æ•°æ®æœåŠ¡)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ModelManager (æ¨¡å‹ç®¡ç†å™¨)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CSV Data Files (æ•°æ®æ–‡ä»¶)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
ç”¨æˆ·è¯·æ±‚ â†’ è¯·æ±‚éªŒè¯ â†’ å†å²æ•°æ®è·å– â†’ æ•°æ®é¢„å¤„ç† â†’ æ¨¡å‹é¢„æµ‹ â†’ ç»“æœè¿”å›
    â†“           â†“           â†“           â†“           â†“           â†“
 å‚æ•°æ ¡éªŒ   æ¨¡å‹å¯ç”¨æ€§   CSVæ–‡ä»¶è¯»å–   ç¼ºå¤±å€¼å¤„ç†   MLæ¨ç†    å“åº”æ„é€ 
```

## ğŸ¯ æ€»ç»“

API V2ç‰ˆæœ¬å®Œç¾è§£å†³äº†æ‚¨æå‡ºçš„æ ¸å¿ƒé—®é¢˜ï¼š

> **"APIæ¥å£çš„inputä¸å¯¹ï¼Œä½ åº”è¯¥input60å¤©çš„å†å²æ•°æ®ï¼Œä½†æ˜¯60å¤©çš„æ•°æ®å…¨éƒ¨æ”¾å…¥inputæ˜¯ä¸æ˜¯ä¸å¥½çœ‹ï¼Ÿ"**

**è§£å†³æ–¹æ¡ˆï¼š**
- âœ… **ä¸å†éœ€è¦**ç”¨æˆ·æä¾›60å¤©Ã—12ç‰¹å¾çš„åºå¤§è¾“å…¥
- âœ… **æ™ºèƒ½è·å–**ï¼šç³»ç»Ÿè‡ªåŠ¨ä»CSVæ–‡ä»¶è·å–å†å²æ•°æ®
- âœ… **ç®€æ´ç¾è§‚**ï¼šAPIè¾“å…¥ä»720ä¸ªæ•°å€¼ç®€åŒ–ä¸º5ä¸ªæ ¸å¿ƒå‚æ•°
- âœ… **åŠŸèƒ½å¢å¼º**ï¼šæ–°å¢æ•°æ®éªŒè¯ã€æ‰¹é‡å¤„ç†ã€æ··åˆæ¨¡å¼ç­‰åŠŸèƒ½

è¿™æ ·çš„è®¾è®¡æ—¢è§£å†³äº†æŠ€æœ¯é—®é¢˜ï¼Œåˆç¬¦åˆå®é™…ä¸šåŠ¡éœ€æ±‚ï¼Œè®©APIçœŸæ­£å¥½ç”¨ã€æ˜“ç”¨ï¼

---

ğŸ“ **æŠ€æœ¯æ”¯æŒ**
å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹ï¼š
- APIæ–‡æ¡£ï¼šhttp://localhost:8001/docs
- æ¼”ç¤ºè„šæœ¬ï¼š`python demo_api_v2.py`
- æ—¥å¿—æ–‡ä»¶ï¼š`logs/api_v2.log`



## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ ¸å¿ƒAPIæ¥å£
- **é¢„æµ‹æ¥å£** (`POST /api/predict`): æ”¯æŒ1-30å¤©çš„è“è—»å¯†åº¦å¢é•¿ç‡é¢„æµ‹
- **æ€§èƒ½å¯¹æ¯”æ¥å£** (`POST /api/model-performance`): æä¾›æ¨¡å‹æ€§èƒ½åˆ†æå’Œå¯¹æ¯”
- **é…ç½®æ¥å£**: ç«™ç‚¹åˆ—è¡¨ã€æ¨¡å‹ä¿¡æ¯ã€è¾“å…¥æ ¼å¼è¯´æ˜
- **å¥åº·æ£€æŸ¥æ¥å£**: æœåŠ¡çŠ¶æ€ç›‘æ§

### 2. å¤šæ¨¡å‹æ”¯æŒ
- **LSTM**: åŸºå‡†æ¨¡å‹ï¼Œé•¿çŸ­æœŸè®°å¿†ç½‘ç»œ
- **GRU-D**: æ¨èæ¨¡å‹ï¼Œä¸“ä¸ºç¼ºå¤±æ•°æ®è®¾è®¡ï¼Œå¹³å‡æ”¹å–„ç‡50.07%
- **TCN**: æ—¶é—´å·ç§¯ç½‘ç»œï¼Œé€‚åˆé•¿åºåˆ—é¢„æµ‹
- **XGBoost**: æ¢¯åº¦æå‡æ ‘ï¼Œåœ¨ç‰¹å®šç«™ç‚¹è¡¨ç°ä¼˜å¼‚

### 3. 6ä¸ªç›‘æµ‹ç«™ç‚¹å…¨è¦†ç›–
- **é‡æ±¡æŸ“ä¸é«˜é£é™©åŒº**: èƒ¥æ¹–å¿ƒã€é”¡ä¸œæ°´å‚
- **èƒŒæ™¯ä¸å‚ç…§åŒº**: å¹³å°å±±ã€æ‹–å±±(tuoshan)  
- **è¾¹ç•Œæ¡ä»¶åŒº**: å…°å±±å˜´(lanshanzui)ã€äº”é‡Œæ¹–å¿ƒ

### 4. å®Œæ•´çš„æ•°æ®å¤„ç†æµç¨‹
- **è¾“å…¥éªŒè¯**: 12ä¸ªæ°´è´¨å’Œæ°”è±¡æŒ‡æ ‡çš„èŒƒå›´æ£€æŸ¥
- **æ•°æ®é¢„å¤„ç†**: æ ‡å‡†åŒ–ã€æ—¶é—´åºåˆ—æ„å»º
- **æ¨¡å‹é€‚é…**: ä¸åŒæ¨¡å‹ç±»å‹çš„æ•°æ®æ ¼å¼è½¬æ¢
- **ç»“æœåå¤„ç†**: é¢„æµ‹å€¼åˆç†æ€§æ£€æŸ¥å’Œç½®ä¿¡åº¦è®¡ç®—

### 5. é«˜æ€§èƒ½æ¶æ„
- **å¼‚æ­¥è®¾è®¡**: åŸºäºFastAPIçš„å¼‚æ­¥Webæ¡†æ¶
- **å¹¶å‘å¤„ç†**: å¤šçº¿ç¨‹æ¨¡å‹åŠ è½½å’Œé¢„æµ‹
- **ç¼“å­˜æœºåˆ¶**: æ¨¡å‹é¢„åŠ è½½å’Œæ€§èƒ½æ•°æ®ç¼“å­˜
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•

## ğŸ“ é¡¹ç›®ç»“æ„


## ğŸš€ å¿«é€Ÿå¯åŠ¨æŒ‡å—

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒï¼ˆå¯é€‰ï¼‰
cp env.example .env
```

### 2. å¯åŠ¨æœåŠ¡
```bash
# æ–¹å¼1: ä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰
python start_server.py

# æ–¹å¼2: ç›´æ¥å¯åŠ¨
python main.py

# æ–¹å¼3: ä½¿ç”¨uvicorn
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 3. è®¿é—®API
- **APIæ–‡æ¡£**: http://localhost:8000/docs
- **å¥åº·æ£€æŸ¥**: http://localhost:8000/health
- **æ›¿ä»£æ–‡æ¡£**: http://localhost:8000/redoc



## 1. è¾“å…¥æ–‡ä»¶æ ¼å¼ä¸ç»“æ„

è¾“å…¥æ•°æ®æ˜¯æ¨¡å‹è®­ç»ƒå’Œé¢„æµ‹çš„åŸºç¡€ã€‚æ ¡æ ¸æ—¶éœ€ç¡®ä¿APIä½¿ç”¨çš„æ•°æ®æºéµå¾ªä»¥ä¸‹æ ¼å¼ã€‚

### 1.1. æ–‡ä»¶ä½ç½®ä¸å‘½å

- **å­˜å‚¨ä½ç½®**: æ‰€æœ‰åŸå§‹æ•°æ®æ–‡ä»¶åº”ç»Ÿä¸€å­˜æ”¾ï¼Œä¾¿äºç®¡ç†ã€‚
- **å‘½åè§„èŒƒ**: æ–‡ä»¶ååº”æ¸…æ™°åœ°æ ‡è¯†å…¶å¯¹åº”çš„ç›‘æµ‹ç«™ç‚¹ï¼Œæ ¼å¼ä¸º `002-æ°”è±¡-{ç«™å}-merged_with_weather_with_composite_features.csv`ã€‚

### 1.2. CSVæ–‡ä»¶ç»“æ„

æ¯ä¸ªCSVæ–‡ä»¶åº”ä¸ºä¸€ä¸ªæ ‡å‡†çš„æ—¶é—´åºåˆ—è¡¨æ ¼ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®åˆ—ï¼š

- **æ—¶é—´ç´¢å¼•**: å¿…é¡»æœ‰ä¸€åˆ—è¡¨ç¤ºæ—¥æœŸï¼ˆä¾‹å¦‚ `date` æˆ– `time`ï¼‰ï¼Œç”¨äºæ’åºå’Œåˆ’åˆ†æ•°æ®é›†ã€‚
- **æ ¸å¿ƒç‰¹å¾åˆ—**: å¿…é¡»åŒ…å«ä»¥ä¸‹12ä¸ªåœ¨ `base_features` ä¸­å®šä¹‰çš„åŸºç¡€æŒ‡æ ‡ï¼Œåˆ—åå’Œå•ä½éœ€ä¿æŒä¸€è‡´ã€‚

| å­—æ®µ (Field)                | æè¿° (Description)         | å•ä½ (Unit) |
| --------------------------- | -------------------------- | ----------- |
| `temperature`               | æ¸©åº¦                       | Â°C          |
| `pH`                        | pHå€¼                       | -           |
| `oxygen`                    | æº¶è§£æ°§                     | mg/L        |
| `permanganate`              | é«˜é”°é…¸ç›æŒ‡æ•°               | mg/L        |
| `TN`                        | æ€»æ°®                       | mg/L        |
| `conductivity`              | ç”µå¯¼ç‡                     | Î¼S/cm       |
| `turbidity`                 | æµŠåº¦                       | NTU         |
| `density`                   | **ç›®æ ‡å˜é‡**ï¼šè—»å¯†åº¦       | cells/L     |
| `rain_sum`                  | é™é›¨é‡                     | mm          |
| `wind_speed_10m_max`        | æœ€å¤§10ç±³é£é€Ÿ               | m/s         |
| `shortwave_radiation_sum`   | çŸ­æ³¢è¾å°„æ€»é‡               | MJ/mÂ²       |

## 2. è¾“å‡ºæ–‡ä»¶æ ¼å¼ä¸ç»“æ„

æ¨¡å‹è®­ç»ƒæˆ–æ‰¹é‡é¢„æµ‹åç”Ÿæˆçš„ä¸­é—´ç»“æœæ–‡ä»¶ï¼Œåº”éµå¾ªç»Ÿä¸€çš„åºåˆ—åŒ–æ ¼å¼ï¼Œä»¥ä¾¿äºæ¨¡å‹å¯¹æ¯”å’Œæ€§èƒ½è¯„ä¼°ã€‚

### 2.1. æ–‡ä»¶ç±»å‹ä¸å‘½å

- **æ–‡ä»¶ç±»å‹**: æ‰€æœ‰è¾“å‡ºç»“æœå‡åº”ä¿å­˜ä¸º `.pkl` æ–‡ä»¶ï¼Œä½¿ç”¨ `pickle` æ¨¡å—è¿›è¡Œåºåˆ—åŒ–ã€‚
- **å‘½åè§„èŒƒ**: æ–‡ä»¶ååº”æ¸…æ™°åœ°æ ‡è¯†æ¨¡å‹ç±»å‹å’Œç«™ç‚¹ï¼Œæ ¼å¼ä¸º `00-{æ¨¡å‹å¤§å†™å}_model_data_{ç«™å}-å»é™¤è´Ÿæ•°.pkl`ã€‚
  - ä¾‹å¦‚: `00-LSTM_model_data_èƒ¥æ¹–å¿ƒ-å»é™¤è´Ÿæ•°.pkl`

### 2.2. Pickleæ–‡ä»¶å†…å®¹ç»“æ„

æ¯ä¸ª `.pkl` æ–‡ä»¶è§£åŒ…ååº”ä¸ºä¸€ä¸ªPythonå­—å…¸ï¼Œè‡³å°‘åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªé”®ï¼š

- `predictions_all`: å­˜å‚¨é¢„æµ‹å€¼ã€‚
- `actual_values_all`: å­˜å‚¨å¯¹åº”çš„çœŸå®å€¼ã€‚

è¿™ä¸¤ä¸ªé”®çš„å€¼æœ¬èº«ä¹Ÿæ˜¯å­—å…¸ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š

```python
# .pkl æ–‡ä»¶å†…å®¹ç¤ºä¾‹
{
  "predictions_all": {
    1: numpy.array([...]),  # T+1å¤©çš„æ‰€æœ‰é¢„æµ‹å€¼
    2: numpy.array([...]),  # T+2å¤©çš„æ‰€æœ‰é¢„æµ‹å€¼
    ...
    30: numpy.array([...])  # T+30å¤©çš„æ‰€æœ‰é¢„æµ‹å€¼
  },
  "actual_values_all": {
    1: numpy.array([...]),  # T+1å¤©çš„æ‰€æœ‰çœŸå®å€¼
    2: numpy.array([...]),  # T+2å¤©çš„æ‰€æœ‰çœŸå®å€¼
    ...
    30: numpy.array([...])  # T+30å¤©çš„æ‰€æœ‰çœŸå®å€¼
  }
}
```

- **é”® (Key)**: æ•´æ•°ï¼Œè¡¨ç¤ºé¢„æµ‹æœªæ¥å¤©æ•°ï¼ˆ1åˆ°30ï¼‰ã€‚
- **å€¼ (Value)**: `numpy.ndarray`ï¼ŒåŒ…å«è¯¥é¢„æµ‹å¤©æ•°ä¸‹æ‰€æœ‰æ—¶é—´ç‚¹çš„é¢„æµ‹/çœŸå®å€¼åºåˆ—ã€‚

## 3. æœºå™¨å­¦ä¹ æ¨¡å‹Classç»“æ„

é¡¹ç›®ä¸­å®ç°çš„å››ä¸ªæ ¸å¿ƒæ¨¡å‹ï¼Œå…¶ç±»å®šä¹‰åº”ä¸å‚è€ƒä»£ç ä¿æŒä¸€è‡´ï¼Œä»¥ç¡®ä¿æ¨¡å‹åŠ è½½å’Œè°ƒç”¨çš„å…¼å®¹æ€§ã€‚

### 3.1. LSTMModel

- **ç»§æ‰¿**: `torch.nn.Module`
- **åˆå§‹åŒ–å‚æ•°**: `__init__(self, input_size, hidden_size, num_layers, output_size, dropout=0.2)`
- **æ ¸å¿ƒå±‚**:
  - `self.lstm = nn.LSTM(...)`
  - `self.fc = nn.Linear(...)`
- **`forward`æ–¹æ³•**: æ¥å—è¾“å…¥å¼ é‡ `x`ï¼Œè¿”å›çº¿æ€§å±‚çš„è¾“å‡ºã€‚

```python
import torch.nn as nn

class LSTMModel(nn.Module):
    def __init__(self, input_size, hidden_size, num_layers, output_size, dropout=0.2):
        super(LSTMModel, self).__init__()
        self.lstm = nn.LSTM(input_size, hidden_size, num_layers, 
                           batch_first=True, dropout=dropout)
        self.fc = nn.Linear(hidden_size, output_size)
        
    def forward(self, x):
        lstm_out, _ = self.lstm(x)
        out = self.fc(lstm_out[:, -1, :])
        return out
```

### 3.2. GRUDModel

- **ç»§æ‰¿**: `torch.nn.Module`
- **å®ç°ç»†èŠ‚**: GRUDæ¨¡å‹åº”åŸºäº `GRU-D` å•å…ƒæ„å»ºã€‚`GRU-D` çš„å®ç°éœ€è¦ç‰¹åˆ«å…³æ³¨å¯¹ç¼ºå¤±æ•°æ®çš„å¤„ç†é€»è¾‘ï¼Œå°½ç®¡åœ¨å‚è€ƒä»£ç ä¸­å®ƒè¢«ç®€åŒ–ä¸ºæ ‡å‡†çš„GRUã€‚
- **åˆå§‹åŒ–å‚æ•°**: `__init__(self, input_size, hidden_size, num_layers, output_size, dropout=0.2)`
- **æ ¸å¿ƒå±‚**:
  - `self.gru = nn.GRU(...)`
  - `self.fc = nn.Linear(...)`
- **`forward`æ–¹æ³•**: æ¥å—è¾“å…¥å¼ é‡ `x`ï¼Œåˆå§‹åŒ–éšè—çŠ¶æ€ `h0`ï¼Œå¹¶è¿”å›çº¿æ€§å±‚çš„è¾“å‡ºã€‚

```python
import torch
import torch.nn as nn

class GRU_D(nn.Module):
    def __init__(self, input_size, hidden_size, num_layers, output_size, dropout=0.2):
        super(GRU_D, self).__init__()
        self.hidden_size = hidden_size
        self.num_layers = num_layers
        self.gru = nn.GRU(input_size, hidden_size, num_layers, batch_first=True, dropout=dropout)
        self.fc = nn.Linear(hidden_size, output_size)
        
    def forward(self, x):
        h0 = torch.zeros(self.num_layers, x.size(0), self.hidden_size).to(x.device)
        out, _ = self.gru(x, h0)
        out = self.fc(out[:, -1, :])
        return out

# Wrapper Class
class GRUDModel(nn.Module):
    def __init__(self, input_size, hidden_size, num_layers, output_size, dropout=0.2):
        super(GRUDModel, self).__init__()
        self.grud = GRU_D(input_size, hidden_size, num_layers, output_size, dropout)
        
    def forward(self, x):
        return self.grud(x)
```

### 3.3. TCNModel

- **ç»§æ‰¿**: `torch.nn.Module`
- **ä¾èµ–æ¨¡å—**: ä¾èµ– `TemporalBlock` å’Œ `Chomp1d` ä¸¤ä¸ªè¾…åŠ©ç±»ã€‚
- **åˆå§‹åŒ–å‚æ•°**: `__init__(self, input_size, output_size, num_channels, kernel_size=2, dropout=0.2)`
  - `num_channels`: æ˜¯ä¸€ä¸ªæ•´æ•°åˆ—è¡¨ï¼Œå®šä¹‰äº†æ¯ä¸ªæ—¶é—´å·ç§¯å—çš„è¾“å‡ºé€šé“æ•°ã€‚
- **æ ¸å¿ƒå±‚**:
  - `self.network = nn.Sequential(*layers)`ï¼Œå…¶ä¸­ `layers` æ˜¯ `TemporalBlock` çš„åˆ—è¡¨ã€‚
  - `self.linear = nn.Linear(...)`
- **`forward`æ–¹æ³•**: æ¥å—è¾“å…¥ `x`ï¼Œæ³¨æ„å†…éƒ¨æœ‰ `x.transpose(1, 2)` æ“ä½œä»¥åŒ¹é…å·ç§¯å±‚æœŸæœ›çš„ `(N, C, L)` æ ¼å¼ã€‚

```python
import torch.nn as nn
# (éœ€è¦åŒæ—¶å®ç° Chomp1d å’Œ TemporalBlock ç±»)

class TCNModel(nn.Module):
    def __init__(self, input_size, output_size, num_channels, kernel_size=2, dropout=0.2):
        super(TCNModel, self).__init__()
        layers = []
        num_levels = len(num_channels)
        for i in range(num_levels):
            dilation_size = 2 ** i
            in_channels = input_size if i == 0 else num_channels[i-1]
            out_channels = num_channels[i]
            layers += [TemporalBlock(in_channels, out_channels, kernel_size,
                                   stride=1, dilation=dilation_size,
                                   padding=(kernel_size-1) * dilation_size,
                                   dropout=dropout)]
        self.network = nn.Sequential(*layers)
        self.linear = nn.Linear(num_channels[-1], output_size)

    def forward(self, x):
        x = x.transpose(1, 2)
        x = self.network(x)
        x = x[:, :, -1]
        return self.linear(x)
```

### 3.4. XGBoostModel

- **ç±»å‹**: è‡ªå®šä¹‰å°è£…ç±»ï¼Œé `nn.Module`ã€‚
- **æ ¸å¿ƒåº“**: `xgboost.XGBRegressor`
- **`__init__`**: åˆå§‹åŒ–ç©ºçš„ `models` å’Œ `scalers` å­—å…¸ã€‚
- **æ ¸å¿ƒæ–¹æ³•**:
  - `create_features(self, data, seq_length, target_index)`: å°†æ—¶åºæ•°æ®è½¬æ¢ä¸ºç›‘ç£å­¦ä¹ æ ¼å¼ã€‚è¯¥æ–¹æ³•å¿…é¡»å®ç°çª—å£ç‰¹å¾å±•å¹³ï¼ˆflattenï¼‰å’Œç»Ÿè®¡ç‰¹å¾ï¼ˆmean, std, max, minï¼‰çš„æå–ã€‚
  - `train_for_days(self, train_data, seq_length, target_index)`: å°è£…äº† `xgb.XGBRegressor` çš„è®­ç»ƒæµç¨‹ã€‚

```python
import xgboost as xgb
import numpy as np

class XGBoostModel:
    def __init__(self):
        self.models = {}
        self.scalers = {}
        
    def create_features(self, data, seq_length, target_index):
        features = []
        targets = []
        for i in range(seq_length, len(data)):
            window_features = data[i-seq_length:i].flatten()
            window_stats = [
                np.mean(data[i-seq_length:i], axis=0),
                np.std(data[i-seq_length:i], axis=0),
                np.max(data[i-seq_length:i], axis=0),
                np.min(data[i-seq_length:i], axis=0)
            ]
            combined_features = np.concatenate([window_features] + window_stats)
            features.append(combined_features)
            targets.append(data[i, target_index])
        return np.array(features), np.array(targets)
    
    def train_for_days(self, train_data, seq_length, target_index):
        model = xgb.XGBRegressor(
            n_estimators=500,
            max_depth=6,
            learning_rate=0.1,
            random_state=42
        )
        X_train, y_train = self.create_features(train_data, seq_length, target_index)
        model.fit(X_train, y_train)
        return model
```

# ğŸŒŠ è“è—»é¢„æµ‹ç³»ç»ŸAPI V2 ç”¨æˆ·ä½¿ç”¨æŒ‡å—

## ğŸ¯ æ ¸å¿ƒè§£å†³æ–¹æ¡ˆ

æˆ‘ä»¬å®Œå…¨è§£å†³äº†æ‚¨æå‡ºçš„é—®é¢˜ï¼š**"APIæ¥å£çš„inputä¸å¯¹ï¼Œä½ åº”è¯¥input60å¤©çš„å†å²æ•°æ®ï¼Œä½†æ˜¯60å¤©çš„æ•°æ®å…¨éƒ¨æ”¾å…¥inputæ˜¯ä¸æ˜¯ä¸å¥½çœ‹ï¼Ÿ"**

### âŒ åŸæ¥çš„é—®é¢˜
- æ¨¡å‹éœ€è¦60å¤©Ã—12ç‰¹å¾=720ä¸ªæ•°å€¼ï¼Œä½†APIåªæ¥å—1å¤©çš„æ•°æ®
- å¦‚æœç›´æ¥ä¼ å…¥720ä¸ªæ•°å€¼ï¼ŒJSONä¼šæå…¶è‡ƒè‚¿
- ç”¨æˆ·éš¾ä»¥æ„é€ å†å²æ•°æ®

### âœ… ç°åœ¨çš„è§£å†³æ–¹æ¡ˆ
- **æ™ºèƒ½å†å²æ•°æ®è·å–**ï¼šåªéœ€5ä¸ªæ ¸å¿ƒå‚æ•°ï¼Œç³»ç»Ÿè‡ªåŠ¨è·å–60å¤©æ•°æ®
- **ç®€æ´ç¾è§‚çš„API**ï¼šä»720ä¸ªæ•°å€¼ç®€åŒ–ä¸º5ä¸ªå‚æ•°
- **ç¬¦åˆå®é™…ä¸šåŠ¡**ï¼šç¯å¢ƒç›‘æµ‹ç³»ç»Ÿçš„çœŸå®å·¥ä½œæµç¨‹

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å…¬ç½‘åœ°å€
**ç”Ÿäº§ç¯å¢ƒï¼š** https://enfhoccrrryd.sealoshzh.site

### æœ€ç®€å•çš„è°ƒç”¨

```bash
curl -X POST 'https://enfhoccrrryd.sealoshzh.site/api/v2/predict' \
  -H 'Content-Type: application/json' \
  -d '{
    "station": "èƒ¥æ¹–å¿ƒ",
    "model_type": "grud",
    "predict_days": 7,
    "data_mode": "auto_historical",
    "end_date": "2024-05-31"
  }'
```

**å°±è¿™ä¹ˆç®€å•ï¼** ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
1. ä»CSVæ–‡ä»¶è·å–2024-04-02åˆ°2024-05-31çš„60å¤©å†å²æ•°æ®
2. æå–æ¸©åº¦ã€pHã€æº¶æ°§ç­‰12ä¸ªç‰¹å¾
3. å¤„ç†ç¼ºå¤±å€¼å’Œæ•°æ®é¢„å¤„ç†
4. è°ƒç”¨GRU-Dæ¨¡å‹è¿›è¡Œ7å¤©é¢„æµ‹

## ğŸ“Š æ”¯æŒçš„åŠŸèƒ½

### 1. åŸºç¡€é¢„æµ‹ï¼ˆæ¨èï¼‰

```python
import requests

def predict_algae():
    url = "https://enfhoccrrryd.sealoshzh.site/api/v2/predict"
    
    payload = {
        "station": "èƒ¥æ¹–å¿ƒ",        # ç›‘æµ‹ç«™ç‚¹
        "model_type": "grud",       # æ¨èä½¿ç”¨GRUDæ¨¡å‹
        "predict_days": 7,          # é¢„æµ‹7å¤©
        "data_mode": "auto_historical",  # è‡ªåŠ¨è·å–å†å²æ•°æ®
        "end_date": "2024-05-31"    # å†å²æ•°æ®ç»“æŸæ—¥æœŸ
    }
    
    response = requests.post(url, json=payload)
    return response.json()

# è°ƒç”¨é¢„æµ‹
result = predict_algae()
print(f"é¢„æµ‹ç»“æœ: {result['data']['prediction']}")
```

### 2. æ··åˆæ¨¡å¼ï¼ˆå†å²æ•°æ®+å®æ—¶è¡¥å……ï¼‰

```python
def predict_with_real_time_data():
    payload = {
        "station": "èƒ¥æ¹–å¿ƒ",
        "model_type": "grud",
        "predict_days": 5,
        "data_mode": "hybrid",      # æ··åˆæ¨¡å¼
        "end_date": "2024-05-31",
        "supplementary_data": [     # å®æ—¶ç›‘æµ‹æ•°æ®
            {
                "date": "2024-05-30",
                "temperature": 27.1,
                "oxygen": 7.9,
                "pH": 7.9
            },
            {
                "date": "2024-05-31",
                "temperature": 28.0,
                "oxygen": 7.5,
                "pH": 8.0
            }
        ]
    }
    
    response = requests.post(
        "https://enfhoccrrryd.sealoshzh.site/api/v2/predict", 
        json=payload
    )
    return response.json()
```

### 3. æ‰¹é‡é¢„æµ‹ï¼ˆå¤šç«™ç‚¹ï¼‰

```python
def batch_predict():
    payload = {
        "requests": [
            {
                "station": "èƒ¥æ¹–å¿ƒ",
                "model_type": "grud",
                "predict_days": 7,
                "data_mode": "auto_historical",
                "end_date": "2024-05-31"
            },
            {
                "station": "é”¡ä¸œæ°´å‚",
                "model_type": "grud", 
                "predict_days": 7,
                "data_mode": "auto_historical",
                "end_date": "2024-05-31"
            }
        ],
        "parallel_execution": True
    }
    
    response = requests.post(
        "https://enfhoccrrryd.sealoshzh.site/api/v2/batch-predict", 
        json=payload
    )
    return response.json()
```

## ğŸ¯ æ”¯æŒçš„ç«™ç‚¹å’Œæ¨¡å‹

### ç›‘æµ‹ç«™ç‚¹ï¼ˆ6ä¸ªï¼‰
| ç«™ç‚¹åç§° | è‹±æ–‡åç§° | æ¨èæ¨¡å‹ | æ”¹å–„ç‡ |
|---------|----------|----------|--------|
| èƒ¥æ¹–å¿ƒ | Xuhu Center | grud | 77.4% |
| é”¡ä¸œæ°´å‚ | Xidong Water Plant | grud | 55.1% |
| å¹³å°å±± | Pingtai Mountain | xgboost | 100% |
| tuoshan | Tuoshan Mountain | grud | 79.8% |
| lanshanzui | Lanshan Cape | grud | 28.8% |
| äº”é‡Œæ¹–å¿ƒ | Wulihu Center | grud | 42.9% |

### é¢„æµ‹æ¨¡å‹ï¼ˆ4ç§ï¼‰
| æ¨¡å‹ç±»å‹ | åç§° | ç‰¹ç‚¹ | æ¨èåº¦ |
|---------|------|------|--------|
| grud | GRU-D | å¤„ç†ç¼ºå¤±æ•°æ®ï¼Œç²¾åº¦é«˜ | â­â­â­â­â­ |
| lstm | LSTM | åŸºå‡†æ¨¡å‹ï¼Œç¨³å®šå¯é  | â­â­â­ |
| tcn | TCN | å¹¶è¡Œè®¡ç®—ï¼Œé€Ÿåº¦å¿« | â­â­â­ |
| xgboost | XGBoost | åœ¨å¹³å°å±±è¡¨ç°æœ€ä½³ | â­â­â­â­ |

## ğŸ“ å‚æ•°è¯´æ˜

### å¿…å¡«å‚æ•°
- `station`: ç›‘æµ‹ç«™ç‚¹åç§°
- `model_type`: é¢„æµ‹æ¨¡å‹ç±»å‹
- `predict_days`: é¢„æµ‹å¤©æ•° (1-30)
- `data_mode`: æ•°æ®è·å–æ¨¡å¼
- `end_date`: å†å²æ•°æ®ç»“æŸæ—¥æœŸ (YYYY-MM-DD)

### å¯é€‰å‚æ•°
- `seq_length`: å†å²åºåˆ—é•¿åº¦ (é»˜è®¤60å¤©)
- `validate_data_quality`: æ˜¯å¦éªŒè¯æ•°æ®è´¨é‡
- `fill_missing_method`: ç¼ºå¤±å€¼å¡«å……æ–¹æ³•

## ğŸ“ˆ å“åº”æ ¼å¼

æˆåŠŸå“åº”ç¤ºä¾‹ï¼š
```json
{
  "success": true,
  "message": "æˆåŠŸé¢„æµ‹ èƒ¥æ¹–å¿ƒ æœªæ¥ 7 å¤©çš„è“è—»å¯†åº¦å˜åŒ–",
  "data": {
    "prediction": [0.12, 0.15, 0.18, 0.21, 0.19, 0.16, 0.14],
    "prediction_dates": [
      "2024-06-01", "2024-06-02", "2024-06-03", 
      "2024-06-04", "2024-06-05", "2024-06-06", "2024-06-07"
    ],
    "input_stats": {
      "mean_temperature": 25.8,
      "mean_oxygen": 8.1,
      "data_coverage": 0.98
    },
    "quality_report": {
      "score": 0.876,
      "warnings": [],
      "missing_ratio": 0.022
    }
  }
}
```

## ğŸ› ï¸ å¸¸ç”¨ä»£ç ç‰‡æ®µ

### JavaScript (å‰ç«¯)
```javascript
async function predictAlgae() {
    const response = await fetch('https://enfhoccrrryd.sealoshzh.site/api/v2/predict', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            station: 'èƒ¥æ¹–å¿ƒ',
            model_type: 'grud',
            predict_days: 7,
            data_mode: 'auto_historical',
            end_date: '2024-05-31'
        })
    });
    
    const result = await response.json();
    console.log(result.data.prediction);
}
```

### Python (å®Œæ•´é”™è¯¯å¤„ç†)
```python
import requests
from typing import Optional, Dict, Any

def safe_predict(station: str, model_type: str, predict_days: int) -> Optional[Dict[str, Any]]:
    """å®‰å…¨çš„é¢„æµ‹è°ƒç”¨ï¼ŒåŒ…å«å®Œæ•´é”™è¯¯å¤„ç†"""
    url = "https://enfhoccrrryd.sealoshzh.site/api/v2/predict"
    
    payload = {
        "station": station,
        "model_type": model_type,
        "predict_days": predict_days,
        "data_mode": "auto_historical",
        "end_date": "2024-05-31"
    }
    
    try:
        response = requests.post(url, json=payload, timeout=30)
        
        if response.status_code == 200:
            return {"success": True, "data": response.json()}
        else:
            return {"success": False, "error": f"HTTP {response.status_code}"}
            
    except requests.exceptions.Timeout:
        return {"success": False, "error": "è¯·æ±‚è¶…æ—¶"}
    except requests.exceptions.ConnectionError:
        return {"success": False, "error": "è¿æ¥å¤±è´¥"}
    except Exception as e:
        return {"success": False, "error": str(e)}

# ä½¿ç”¨ç¤ºä¾‹
result = safe_predict("èƒ¥æ¹–å¿ƒ", "grud", 7)
if result["success"]:
    predictions = result["data"]["data"]["prediction"]
    print(f"é¢„æµ‹ç»“æœ: {predictions}")
else:
    print(f"é¢„æµ‹å¤±è´¥: {result['error']}")
```

## ğŸ” æœ€ä½³å®è·µ

### 1. æ¨èé…ç½®
```python
# å„ç«™ç‚¹æ¨èçš„æ¨¡å‹é…ç½®
RECOMMENDED_CONFIG = {
    "èƒ¥æ¹–å¿ƒ": "grud",      # 77.4% æ”¹å–„ç‡
    "é”¡ä¸œæ°´å‚": "grud",    # 55.1% æ”¹å–„ç‡  
    "å¹³å°å±±": "xgboost",   # 100% æ”¹å–„ç‡
    "tuoshan": "grud",     # 79.8% æ”¹å–„ç‡
    "lanshanzui": "grud",  # 28.8% æ”¹å–„ç‡
    "äº”é‡Œæ¹–å¿ƒ": "grud"     # 42.9% æ”¹å–„ç‡
}

def get_recommended_prediction(station: str, predict_days: int = 7):
    """ä½¿ç”¨æ¨èé…ç½®è¿›è¡Œé¢„æµ‹"""
    model_type = RECOMMENDED_CONFIG.get(station, "grud")
    
    payload = {
        "station": station,
        "model_type": model_type,
        "predict_days": predict_days,
        "data_mode": "auto_historical",
        "end_date": "2024-05-31"
    }
    
    response = requests.post(
        "https://enfhoccrrryd.sealoshzh.site/api/v2/predict", 
        json=payload
    )
    return response.json()
```

### 2. æ•°æ®è´¨é‡ç›‘æ§
```python
def predict_with_quality_check(station: str, model_type: str, predict_days: int):
    """å¸¦æ•°æ®è´¨é‡æ£€æŸ¥çš„é¢„æµ‹"""
    payload = {
        "station": station,
        "model_type": model_type,
        "predict_days": predict_days,
        "data_mode": "auto_historical",
        "end_date": "2024-05-31",
        "validate_data_quality": True  # å¯ç”¨è´¨é‡éªŒè¯
    }
    
    response = requests.post(
        "https://enfhoccrrryd.sealoshzh.site/api/v2/predict", 
        json=payload
    )
    
    if response.status_code == 200:
        result = response.json()
        quality = result.get("data", {}).get("quality_report", {})
        
        print(f"æ•°æ®è´¨é‡åˆ†æ•°: {quality.get('score', 0):.3f}")
        if quality.get('warnings'):
            print(f"è´¨é‡è­¦å‘Š: {quality['warnings']}")
        
        return result
    else:
        print(f"é¢„æµ‹å¤±è´¥: {response.status_code}")
        return None
```

### 3. é‡è¯•æœºåˆ¶
```python
import time

def predict_with_retry(payload: dict, max_retries: int = 3) -> dict:
    """å¸¦é‡è¯•æœºåˆ¶çš„é¢„æµ‹è°ƒç”¨"""
    url = "https://enfhoccrrryd.sealoshzh.site/api/v2/predict"
    
    for attempt in range(max_retries):
        try:
            response = requests.post(url, json=payload, timeout=30)
            
            if response.status_code == 200:
                return response.json()
            elif response.status_code in [500, 503]:
                # æœåŠ¡å™¨é”™è¯¯ï¼Œå¯ä»¥é‡è¯•
                if attempt < max_retries - 1:
                    wait_time = 2 ** attempt  # æŒ‡æ•°é€€é¿
                    print(f"æœåŠ¡å™¨é”™è¯¯ï¼Œ{wait_time}ç§’åé‡è¯•...")
                    time.sleep(wait_time)
                    continue
            else:
                # å®¢æˆ·ç«¯é”™è¯¯ï¼Œä¸é‡è¯•
                break
                
        except requests.exceptions.RequestException:
            if attempt < max_retries - 1:
                time.sleep(2)
                continue
    
    return {"success": False, "error": "é‡è¯•åä»ç„¶å¤±è´¥"}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **APIäº¤äº’å¼æ–‡æ¡£**: https://enfhoccrrryd.sealoshzh.site/docs
- **å®Œæ•´APIæŒ‡å—**: `å…¬ç½‘è°ƒç”¨æŒ‡å—.md`
- **å‡çº§è¯´æ˜**: `APIå‡çº§æŒ‡å—V2.md`
- **æµ‹è¯•è®¡åˆ’**: `TODO.md`

## ğŸš¨ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•é€‰æ‹©æœ€ä½³æ¨¡å‹ï¼Ÿ
A: æŸ¥çœ‹æ¨èé…ç½®è¡¨ï¼Œæˆ–ä½¿ç”¨æ¨¡å‹æ€§èƒ½å¯¹æ¯”æ¥å£ï¼š
```bash
curl 'https://enfhoccrrryd.sealoshzh.site/api/model-performance'
```