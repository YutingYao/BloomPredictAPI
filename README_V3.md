# è“è—»é¢„æµ‹ç³»ç»ŸAPI V3 - æç®€ç‰ˆæœ¬

æ¬¢è¿ä½¿ç”¨è“è—»é¢„æµ‹ç³»ç»ŸAPI V3ç‰ˆæœ¬ã€‚æœ¬é¡¹ç›®æ—¨åœ¨æä¾›ä¸€ä¸ª**æç®€ã€æ™ºèƒ½ã€é›¶é…ç½®**çš„è“è—»æ°´åé¢„æµ‹æœåŠ¡ã€‚

V3ç‰ˆæœ¬å®Œç¾è§£å†³äº†ä¹‹å‰ç‰ˆæœ¬ä¸­æ¥å£å¤æ‚çš„æ ¸å¿ƒé—®é¢˜ã€‚ç”¨æˆ·**åªéœ€æä¾›4ä¸ªæ ¸å¿ƒå‚æ•°**ï¼Œç³»ç»Ÿè‡ªåŠ¨å®Œæˆæ‰€æœ‰æ•°æ®å¤„ç†å’Œæ¨¡å‹æ¨ç†å·¥ä½œã€‚

- âœ… **æç®€è®¾è®¡**ï¼šåªéœ€4ä¸ªæ ¸å¿ƒå‚æ•°
- âœ… **é›¶é…ç½®**ï¼šæ— éœ€å…³å¿ƒæ•°æ®è·å–ã€é¢„å¤„ç†ç­‰ç»†èŠ‚
- âœ… **å…¨è‡ªåŠ¨**ï¼šå†å²æ•°æ®è‡ªåŠ¨è·å–ï¼Œå®æ—¶æ•°æ®è‡ªåŠ¨æ›´æ–°
- âœ… **æ™ºèƒ½æ¨ç†**ï¼šæ ¹æ®å½“å‰æ—¥æœŸè‡ªåŠ¨ç¡®å®šå†å²æ•°æ®èŒƒå›´

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœ€ç®€å•çš„é¢„æµ‹è¯·æ±‚

åªéœ€è¦4ä¸ªå‚æ•°å³å¯å®Œæˆé¢„æµ‹ï¼š

```bash
curl -X POST 'http://localhost:8002/api/v3/predict' \
  -H 'Content-Type: application/json' \
  -d '{
    "current_date": "2024-06-01",
    "predict_days": 7,
    "station": "èƒ¥æ¹–å¿ƒ",
    "model_type": "grud"
  }'
```

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. æç®€è®¾è®¡ - åªéœ€4ä¸ªå‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `current_date` | å½“å‰æ—¥æœŸ | "2024-06-01" |
| `predict_days` | é¢„æµ‹å¤©æ•° (1-30) | 7 |
| `station` | é¢„æµ‹ç‚¹ä½ | "èƒ¥æ¹–å¿ƒ" |
| `model_type` | æ¨¡å‹ç±»å‹ | "grud" |

### 2. å…¨è‡ªåŠ¨æ•°æ®å¤„ç†

- **è‡ªåŠ¨å†å²æ•°æ®è·å–**ï¼šæ ¹æ®`current_date`è‡ªåŠ¨è·å–å‰60å¤©å†å²æ•°æ®
- **è‡ªåŠ¨æ•°æ®é¢„å¤„ç†**ï¼šç¼ºå¤±å€¼å¡«å……ã€æ•°æ®æ ‡å‡†åŒ–ç­‰
- **å®æ—¶æ•°æ®æ›´æ–°**ï¼šé€šè¿‡`generate_fake_data.py`è‡ªåŠ¨æ›´æ–°åˆ°CSVæ–‡ä»¶

### 3. æ™ºèƒ½æ¨ç†æœºåˆ¶

```
ç”¨æˆ·è¾“å…¥: current_date = "2024-06-01"
        â†“
ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—: å†å²æ•°æ®æˆªæ­¢ = "2024-05-31"
        â†“ 
è‡ªåŠ¨è·å–: 2024-04-02 åˆ° 2024-05-31 (60å¤©å†å²æ•°æ®)
        â†“
æ‰§è¡Œé¢„æµ‹: 2024-06-01 åˆ° 2024-06-07 (æœªæ¥7å¤©)
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€é¢„æµ‹

```python
import requests

def simple_predict():
    url = "http://localhost:8002/api/v3/predict"
    
    # åªéœ€4ä¸ªæ ¸å¿ƒå‚æ•°
    payload = {
        "current_date": "2024-06-01",  # å½“å‰æ—¥æœŸ
        "predict_days": 7,             # é¢„æµ‹7å¤©
        "station": "èƒ¥æ¹–å¿ƒ",           # ç›‘æµ‹ç«™ç‚¹
        "model_type": "grud"           # æ¨èä½¿ç”¨GRUDæ¨¡å‹
    }
    
    response = requests.post(url, json=payload)
    result = response.json()
    
    print(f"é¢„æµ‹ç»“æœ: {result['data']['prediction']}")
    print(f"é¢„æµ‹æ—¥æœŸ: {result['data']['prediction_dates']}")

simple_predict()
```

### æ‰¹é‡é¢„æµ‹

```python
def batch_predict():
    url = "http://localhost:8002/api/v3/batch-predict"
    
    payload = {
        "requests": [
            {
                "current_date": "2024-06-01",
                "predict_days": 5,
                "station": "èƒ¥æ¹–å¿ƒ",
                "model_type": "grud"
            },
            {
                "current_date": "2024-06-01", 
                "predict_days": 5,
                "station": "é”¡ä¸œæ°´å‚",
                "model_type": "grud"
            }
        ],
        "parallel_execution": True
    }
    
    response = requests.post(url, json=payload)
    return response.json()

result = batch_predict()
print(result)
```

### è¯·æ±‚éªŒè¯

```python
def validate_request():
    url = "http://localhost:8002/api/v3/validate"
    
    payload = {
        "current_date": "2024-06-01",
        "predict_days": 14,
        "station": "èƒ¥æ¹–å¿ƒ", 
        "model_type": "grud"
    }
    
    response = requests.post(url, json=payload)
    validation = response.json()['validation_result']
    
    print(f"è¯·æ±‚æœ‰æ•ˆ: {validation['valid']}")
    print(f"è‡ªåŠ¨æˆªæ­¢æ—¥æœŸ: {validation['auto_end_date']}")
    
validate_request()
```

## ğŸ¯ æ”¯æŒçš„ç«™ç‚¹å’Œæ¨¡å‹

### ç›‘æµ‹ç«™ç‚¹ (6ä¸ª)

| ç«™ç‚¹åç§° | è‹±æ–‡åç§° | æ¨èæ¨¡å‹ |
|---------|----------|----------|
| èƒ¥æ¹–å¿ƒ | Xuhu Center | grud |
| é”¡ä¸œæ°´å‚ | Xidong Water Plant | grud |
| å¹³å°å±± | Pingtai Mountain | xgboost |
| tuoshan | Tuoshan Mountain | grud |
| lanshanzui | Lanshan Cape | grud |
| äº”é‡Œæ¹–å¿ƒ | Wulihu Center | grud |

### é¢„æµ‹æ¨¡å‹ (4ç§)

| æ¨¡å‹ç±»å‹ | åç§° | ç‰¹ç‚¹ | æ¨èåº¦ |
|---------|------|------|--------|
| grud | GRU-D | å¤„ç†ç¼ºå¤±æ•°æ®ï¼Œç²¾åº¦é«˜ | â­â­â­â­â­ |
| lstm | LSTM | åŸºå‡†æ¨¡å‹ï¼Œç¨³å®šå¯é  | â­â­â­ |
| tcn | TCN | å¹¶è¡Œè®¡ç®—ï¼Œé€Ÿåº¦å¿« | â­â­â­ |
| xgboost | XGBoost | åœ¨å¹³å°å±±è¡¨ç°æœ€ä½³ | â­â­â­â­ |

## ğŸ“š API å‚è€ƒ

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/api/v3/predict` | POST | æç®€é¢„æµ‹æ¥å£ (4å‚æ•°) |
| `/api/v3/batch-predict` | POST | æ‰¹é‡é¢„æµ‹ |
| `/api/v3/validate` | POST | è¯·æ±‚éªŒè¯ |
| `/api/stations` | GET | æ”¯æŒçš„ç«™ç‚¹åˆ—è¡¨ |
| `/api/models` | GET | æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨ |
| `/api/v3/input-schema` | GET | è¾“å…¥æ ¼å¼è¯´æ˜ |

å®Œæ•´çš„APIæ–‡æ¡£å’Œåœ¨çº¿æµ‹è¯•å·¥å…·è¯·è®¿é—® `http://localhost:8002/docs`

## ğŸ› ï¸ æœ¬åœ°éƒ¨ç½²

### ç¯å¢ƒå‡†å¤‡

```bash
# ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒå®‰è£…ä¾èµ–
pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/
```

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨V3 APIæœåŠ¡
source venv/bin/activate && python main_v3.py
```

æœåŠ¡å°†åœ¨ `http://localhost:8002` å¯åŠ¨ã€‚

## ğŸ”„ ç‰ˆæœ¬å¯¹æ¯”

### APIè°ƒç”¨å¤æ‚åº¦å¯¹æ¯”

**V1ç‰ˆæœ¬ (åŸç‰ˆ)**
```json
{
  "station": "èƒ¥æ¹–å¿ƒ",
  "model_type": "grud",
  "predict_days": 7,
  "input_data": {
    // éœ€è¦720ä¸ªæ•°å€¼ (60å¤©Ã—12ç‰¹å¾)
    "temperature": [25.1, 25.2, ...], // 60ä¸ªå€¼
    "oxygen": [8.1, 8.2, ...],        // 60ä¸ªå€¼
    // ... 10ä¸ªç‰¹å¾ Ã— 60å¤© = 600ä¸ªæ•°å€¼
  }
}
```
âŒ **é—®é¢˜**: éœ€è¦æ‰‹åŠ¨æ„é€ 720ä¸ªæ•°å€¼ï¼Œç”¨æˆ·ä½“éªŒæå·®

**V2ç‰ˆæœ¬ (æ”¹è¿›ç‰ˆ)**
```json
{
  "station": "èƒ¥æ¹–å¿ƒ",
  "model_type": "grud", 
  "predict_days": 7,
  "data_mode": "auto_historical",
  "end_date": "2024-05-31",
  "seq_length": 60,
  "fill_missing_method": "interpolation"
}
```
âœ… **æ”¹è¿›**: è‡ªåŠ¨è·å–å†å²æ•°æ®  
â“ **é—®é¢˜**: ä»éœ€å¤šä¸ªé…ç½®å‚æ•°

**V3ç‰ˆæœ¬ (æç®€ç‰ˆ)**
```json
{
  "current_date": "2024-06-01",
  "predict_days": 7,
  "station": "èƒ¥æ¹–å¿ƒ",
  "model_type": "grud"
}
```
âœ… **ä¼˜åŠ¿**: åªéœ€4ä¸ªæ ¸å¿ƒå‚æ•°ï¼Œé›¶é…ç½®

### åŠŸèƒ½å¯¹æ¯”è¡¨

| ç‰¹æ€§ | V1ç‰ˆæœ¬ | V2ç‰ˆæœ¬ | V3ç‰ˆæœ¬ |
|------|--------|--------|--------|
| å‚æ•°æ•°é‡ | 720+ | 6-8ä¸ª | **4ä¸ª** |
| ç”¨æˆ·ä½“éªŒ | âŒ å¤æ‚ | âš ï¸ ä¸€èˆ¬ | âœ… **æç®€** |
| é…ç½®è¦æ±‚ | âŒ é«˜ | âš ï¸ ä¸­ç­‰ | âœ… **é›¶é…ç½®** |
| è‡ªåŠ¨åŒ–ç¨‹åº¦ | âŒ ä½ | âš ï¸ éƒ¨åˆ† | âœ… **å…¨è‡ªåŠ¨** |
| å­¦ä¹ æˆæœ¬ | âŒ é«˜ | âš ï¸ ä¸­ç­‰ | âœ… **æä½** |

## ğŸ”„ å®æ—¶æ•°æ®æ›´æ–°æœºåˆ¶

V3ç‰ˆæœ¬çš„æ•°æ®æ›´æ–°å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œç”¨æˆ·æ— éœ€æ„ŸçŸ¥ï¼š

```
å®æ—¶ç›‘æµ‹æ•°æ® â†’ generate_fake_data.py â†’ è‡ªåŠ¨æ›´æ–°CSVæ–‡ä»¶ â†’ APIè‡ªåŠ¨ä½¿ç”¨æœ€æ–°æ•°æ®
```

1. **æ•°æ®é‡‡é›†**: ç›‘æµ‹è®¾å¤‡äº§ç”Ÿæ–°çš„å®æ—¶æ•°æ®
2. **è‡ªåŠ¨æ›´æ–°**: `generate_fake_data.py` å®šæœŸè¿è¡Œï¼Œå°†æ–°æ•°æ®è¿½åŠ åˆ°å†å²æ•°æ®CSVæ–‡ä»¶
3. **é€æ˜ä½¿ç”¨**: APIè‡ªåŠ¨ä½¿ç”¨æœ€æ–°çš„å†å²æ•°æ®ï¼Œç”¨æˆ·æ— éœ€ä»»ä½•æ“ä½œ

## ğŸš€ æ¼”ç¤ºè„šæœ¬

```bash
# è¿è¡ŒV3ç‰ˆæœ¬æ¼”ç¤º
python demo_api_v3.py
```

æ¼”ç¤ºè„šæœ¬å°†å±•ç¤ºï¼š
- æç®€é¢„æµ‹æ¥å£ä½¿ç”¨
- æ‰¹é‡é¢„æµ‹åŠŸèƒ½
- è¯·æ±‚éªŒè¯
- APIç‰ˆæœ¬å¯¹æ¯”

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- **APIæ–‡æ¡£**: http://localhost:8002/docs
- **æ¼”ç¤ºè„šæœ¬**: `python demo_api_v3.py`
- **æ—¥å¿—æ–‡ä»¶**: `logs/api_v3.log`

---

ğŸ¯ **è®¾è®¡ç†å¿µ**: "æç®€è‡³ä¸Šï¼Œæ™ºèƒ½è‡³ä¸Š"  
ğŸš€ **æ ¸å¿ƒä»·å€¼**: ç”¨æœ€å°‘çš„å‚æ•°ï¼Œè·å¾—æœ€å‡†ç¡®çš„é¢„æµ‹
